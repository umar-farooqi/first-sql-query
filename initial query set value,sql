WITH FIN_TRANS AS 
(
  SELECT 
      SUM(AFTD.RECEIVING_AMOUNT) AS RECEIVING_AMOUNT,
      AFTD.TRD_TYPE_ID
  FROM AB_FIN_TRANSACTION_DET AFTD
  JOIN AB_FIN_TRANSACTION AFT ON AFT.TR_ID = AFTD.TR_ID
  WHERE AFT.TR_TYPE = 900
    AND AFTD.ORG_ID = :GV_ORG_ID 
    GROUP BY AFTD.TRD_TYPE_ID
)
SELECT 
    NVL(ASD.TOTAL_AMOUNT,0) - NVL(FT.RECEIVING_AMOUNT,0) AS REMAINING_AMOUNT
FROM FIN_TRANS FT  
LEFT JOIN  AB_SO_ORDER_HEAD ASH ON FT.TRD_TYPE_ID = ASH.SO_ID 
LEFT JOIN AB_SO_ORDER_DET ASD   ON ASD.SO_ID = ASH.SO_ID 
WHERE ASH.SO_TYPE IN ('SALE ORDER', 'ASO')
  AND ASH.SO_ID  = :TRD_TYPE_ID
  AND ASD.ORG_ID = :GV_ORG_ID;


  -----new query for chat gpt----------

  SELECT 
    NVL(ASD.TOTAL_AMOUNT,0) -
    NVL((
        SELECT SUM(AFTD.RECEIVING_AMOUNT)
        FROM AB_FIN_TRANSACTION_DET AFTD
        JOIN AB_FIN_TRANSACTION AFT ON AFT.TR_ID = AFTD.TR_ID
        WHERE AFT.TR_TYPE = 900
          AND AFTD.ORG_ID = :GV_ORG_ID
          AND AFTD.TRD_TYPE_ID = ASH.SO_ID
        GROUP BY AFTD.TRD_TYPE_ID
    ),0) AS REMAINING_AMOUNT
FROM AB_SO_ORDER_HEAD ASH
JOIN AB_SO_ORDER_DET ASD ON ASD.SO_ID = ASH.SO_ID
WHERE ASH.SO_TYPE IN ('SALE ORDER', 'ASO')
  AND ASH.SO_ID  = :TRD_TYPE_ID
  AND ASD.ORG_ID = :GV_ORG_ID;
