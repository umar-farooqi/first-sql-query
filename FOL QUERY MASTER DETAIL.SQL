WITH  FOL_AMOUNT AS (
    SELECT     
              MAX(FLDS.ID) AS DET_ID,
               FLDS.MAST_ID FOL_ID ,
              -- FLDS.MATURITY_TYPE,
               LISTAGG(LD.LOOKUP_DET_NAME, ' , ') WITHIN GROUP (ORDER BY LD.LOOKUP_DET_NAME) AS FACILITIES_NAME,
            -- LD.LOOKUP_DET_NAME AS FACILITIES_NAME,
               NVL(SUM(AMOUNT),0) TOAL_FOL_AMOUNT
        FROM
                          AB_FACILITIES_LETTER_DET FLDS
                         JOIN AB_LOOKUP_DETAIL LD ON LD.DET_ID=FLDS.FACILITIES_ID
        WHERE 
                  FLDS.FACILITIES_TYPE='FACILITIES DET'
        AND FLDS.ORG_ID=:GV_ORG_ID
    GROUP BY
                FLDS.MAST_ID --, FLDS.ID
) ,FACILITIES_ACCOUNT_NUMBER AS (
    SELECT
             IDS FLD_ID ,
               LISTAGG(BNK.REG_CODE||' - '||ASRC.REG_NAME, ', ') WITHIN GROUP (ORDER BY ACCOUNT_NO) AS INTITLED_NAME
        FROM
                          AB_FACILITIES_LETTER_DET FLDS
                JOIN AB_SETUP_REGISTRATION BNK ON BNK.SR_ID=FLDS.ACCOUNT_NO AND BNK.REG_TYPE in ('BANK LOV','624')
                 JOIN AB_SETUP_REGISTRATION ASRC ON ASRC.SR_ID=BNK.COMPANY_ID AND ASRC.REG_TYPE='COMPANY'
        WHERE 
                  IMAGE_TYPE='FACILITIES ACCOUNT NUMBER'
        AND FLDS.ORG_ID=:GV_ORG_ID
  GROUP BY
                IDS 
)
    SELECT 
           --FA.DET_ID,
            AFL.ID FOL_ID,
            BNK.REG_NAME BANK_NAME,
            BANK_BRANCH,
           -- FA.MATURITY_TYPE,
           FA.FACILITIES_NAME,
         -- LISTAGG(FA.FACILITIES_NAME, ' , ') WITHIN GROUP (ORDER BY FA.FACILITIES_NAME) AS FACILITIES_NAME,
          FAN.INTITLED_NAME AS ACCOUNT_NO,
            
      TO_CHAR(NVL(TOAL_FOL_AMOUNT, 0), '999G999G999G999G990') AS TOAL_FOL_AMOUNT
            
         
         
    FROM 
                      AB_FACILITIES_LETTER AFL
            JOIN AB_SETUP_REGISTRATION BNK ON BNK.SR_ID=AFL.BANK_ID AND REG_TYPE='BANK'
            JOIN FOL_AMOUNT FA ON FA.FOL_ID=AFL.ID
            LEFT JOIN  FACILITIES_ACCOUNT_NUMBER FAN ON FAN.FLD_ID=FA.DET_ID
    WHERE 
                     AFL.FACILITIES_TYPE = 'FACILITIES MAST'
            AND AFL.ORG_ID = :GV_ORG_ID
            AND AFL.STATUS = 'Y'
          AND FOL_ID not in (1469, 1887)

        --   GROUP BY 
        --   AFL.ID ,
        --     BNK.REG_NAME ,
        --     BANK_BRANCH,
        --      FAN.INTITLED_NAME ,
        --      TOAL_FOL_AMOUNT
  ----/////////////////////////////////////////////////////////////////////////////////////////////////////////// MASTER DETAIL -------------------

WITH FOL_AMOUNT AS (
      SELECT     
        FLDS.ID AS DET_ID,
        FLDS.MAST_ID,
        NVL(SUM(FLDS.AMOUNT), 0) AS TOTAL_FOL_AMOUNT,
        ISSUE_DATE AS ISSUE_DATE,
       -- LISTAGG(LD.LOOKUP_DET_NAME, ' , ') WITHIN GROUP (ORDER BY LD.LOOKUP_DET_NAME) AS FACILITIES_NAME
         LD.LOOKUP_DET_NAME AS FACILITIES_NAME
    FROM AB_FACILITIES_LETTER_DET FLDS
    JOIN AB_LOOKUP_DETAIL LD 
        ON LD.DET_ID = FLDS.FACILITIES_ID
    WHERE FLDS.FACILITIES_TYPE = 'FACILITIES DET'
        AND FLDS.ORG_ID = :GV_ORG_ID
    GROUP BY FLDS.MAST_ID , ISSUE_DATE ,  LD.LOOKUP_DET_NAME , FLDS.ID , FLDS.ACCOUNT_NO 
),

ALL_EVENTS AS (
    -- Opening row
    SELECT
        DET_ID,
        FA.MAST_ID,
        NULL AS UTILIZATION_AMOUNT,
        FA.TOTAL_FOL_AMOUNT AS TOTAL_AMOUNT,
        ISSUE_DATE AS EVENT_DATE,
        0 AS EVENT_TYPE, 
        FACILITIES_NAME,
        NULL AS BG_NUMBER,
       NULL AS SUPPLIER_ID,
       NULL AS SR_ID,
       NULL AS SUPPLIER_NAME
    FROM FOL_AMOUNT FA
  

    UNION ALL

    -- Utilization rows (minus)
    SELECT
       FA.DET_ID,
        FA.MAST_ID,
        AFLS.AMOUNT AS UTILIZATION_AMOUNT,
        NULL AS TOTAL_AMOUNT,
        AFLS.BG_ISSU_DATE AS EVENT_DATE,
        1 AS EVENT_TYPE,
        FACILITIES_NAME,
        AFLS.BG_NUMBER,
        AFLS.SUPPLIER_ID,
        ASR.SR_ID,
        MAX(CASE WHEN ASR.SR_ID = AFLS.SUPPLIER_ID AND ASR.REG_TYPE = 'VENDOR' THEN INITCAP(ASR.PARTY_NAME) ELSE NULL END) AS Supplier_Name

    FROM AB_FACILITIES_LETTER AFLS
    JOIN FOL_AMOUNT FA   ON AFLS.FACILITIES_ID = FA.DET_ID
   LEFT JOIN AB_SETUP_REGISTRATION ASR ON ASR.SR_ID = AFLS.SUPPLIER_ID
    WHERE AFLS.ORG_ID = :GV_ORG_ID
      AND AFLS.AMOUNT > 0
      GROUP BY
    FA.DET_ID,
    FA.MAST_ID,
    AFLS.AMOUNT,
    AFLS.BG_ISSU_DATE,
    FACILITIES_NAME,
    AFLS.BG_NUMBER,
    AFLS.SUPPLIER_ID,
    ASR.SR_ID

    UNION ALL

    -- Return rows (plus back)
    SELECT
        FA.DET_ID,
        FA.MAST_ID,
        NULL AS UTILIZATION_AMOUNT,
        AFLS.AMOUNT AS TOTAL_AMOUNT,
        AFLS.BG_EXPIRE_DATE AS EVENT_DATE,
        2 AS EVENT_TYPE,
        FACILITIES_NAME,
        AFLS.BG_NUMBER,
        AFLS.SUPPLIER_ID,
        ASR.SR_ID,
       MAX(CASE WHEN ASR.SR_ID = AFLS.SUPPLIER_ID AND ASR.REG_TYPE = 'VENDOR' THEN INITCAP(ASR.PARTY_NAME) ELSE NULL END) AS Supplier_Name

    FROM AB_FACILITIES_LETTER AFLS
    JOIN FOL_AMOUNT FA    ON AFLS.FACILITIES_ID = FA.DET_ID
     LEFT JOIN AB_SETUP_REGISTRATION ASR ON ASR.SR_ID = AFLS.SUPPLIER_ID
     
    WHERE AFLS.ORG_ID = :GV_ORG_ID
      AND AFLS.BG_EXPIRE_DATE <= SYSDATE
      GROUP BY
    FA.DET_ID,
    FA.MAST_ID,
    AFLS.AMOUNT,
    AFLS.BG_EXPIRE_DATE,
    FACILITIES_NAME,
    AFLS.BG_NUMBER,
    AFLS.SUPPLIER_ID,
    ASR.SR_ID
)
SELECT
    DET_ID,
    MAST_ID,
    UTILIZATION_AMOUNT,
    TOTAL_AMOUNT,
    TO_CHAR(EVENT_DATE, 'DD-MON-YYYY') AS EVENT_DATE,
    EVENT_TYPE,
    FACILITIES_NAME,
    BG_NUMBER,
   SUPPLIER_ID,
   SR_ID,
   Supplier_Name,
    SUM(
        CASE 
            WHEN EVENT_TYPE = 0 THEN NVL(TOTAL_AMOUNT, 0)          -- Opening (+)
            WHEN EVENT_TYPE = 1 THEN -NVL(UTILIZATION_AMOUNT, 0)   -- Utilization (âˆ’)
            WHEN EVENT_TYPE = 2 THEN NVL(TOTAL_AMOUNT, 0)           -- Return (+)
            ELSE 0
        END
    ) OVER (
        PARTITION BY MAST_ID
        ORDER BY EVENT_DATE,  EVENT_TYPE
        ROWS UNBOUNDED PRECEDING
    ) AS BALANCE
FROM ALL_EVENTS

